半连接队列（**SYN queue**）在 TCP 三次握手过程中就是用来“缓冲未完成连接”的，它本身不能完全防止伪连接（攻击者发假的 SYN 包），但它的设计 **在一定程度上起到过滤和保护作用**。原理大致如下：

---

## 1. 半连接队列的作用

* 当服务器收到客户端的 **SYN** 包时，操作系统会在 **半连接队列** 中记录一个条目（状态是 `SYN_RECV`），同时返回 **SYN-ACK**。
* 只有客户端真正返回 **ACK**（第三次握手），这个条目才会从半连接队列“升级”到全连接队列，进入 `ESTABLISHED` 状态。

👉 好处：伪造的 SYN 包如果没有回 ACK，就永远停留在半连接队列里，**不会消耗应用层资源**（应用层 socket 不会被 accept）。

---

## 2. 半连接队列防伪连接的思路

1. **延迟资源分配**

   * 半连接状态下，系统只分配最小的内核结构（记录 IP、端口、初始序列号等），并不会真正建立 socket 连接。
   * 防止了伪造 SYN 就立刻占用大量内存和进程资源。

2. **超时清理机制**

   * 半连接队列中的条目如果一段时间（如几十秒）没完成握手，会被自动清理。
   * 避免了伪连接无限期占用空间。

3. **SYN Cookie 技术（增强版）**

   * 服务器甚至可以不在半连接队列里保存状态，而是把必要的信息“编码”进返回的 **SYN-ACK 序列号**。
   * 如果客户端是真实的，后续发回的 ACK 里能带回这些信息，服务器再真正分配资源。
   * 这样几乎彻底消除了伪连接占用半连接队列的问题。

---

## 3. 半连接队列的局限

* 队列是有限的，如果攻击者发太多 SYN 包（SYN Flood），仍然可能被打满。
* 队列被打满后，正常用户的请求也会被丢弃，导致拒绝服务。
* 所以半连接队列只是 **基本防护**，真正抵御大规模伪连接攻击，还需要：

  * 启用 **SYN Cookie**；
  * 增大队列长度；
  * 降低超时时间；
  * 配合防火墙/流量清洗。

---

✅ **总结**
半连接队列的机制就是：在三次握手没完成前，只在内核维护一个临时状态，不把连接交给应用层，从而避免伪造 SYN 直接耗尽系统资源。它可以 **减缓伪连接攻击**，但在面对大规模 SYN Flood（DDoS）时，必须配合 **SYN Cookie、队列调优和外部防护措施**。

# 多线程日志调试输出

## 核心函数实现

### print() 函数
```cpp
/**
* @brief 将任意数量的项目打印到输出流中。确保没有其他线程同时打印到此流，只要它们都专门使用同一个`BS::synced_stream`对象进行打印。
*
* @tparam T 项目的类型。
* @param items 要打印的项目。
*/
template <typename... T>
void print(const T&... items)
{
    const std::scoped_lock stream_lock(stream_mutex);
    for (std::ostream* const stream : out_streams)
        (*stream << ... << items);
}
```

### println() 函数
```cpp
/**
* @brief 将任意数量的项目打印到输出流中，然后跟一个换行符。确保没有其他线程同时打印到此流，只要它们都专门使用同一个`BS::synced_stream`对象进行打印。
*
* @tparam T 项目的类型。
* @param items 要打印的项目。
*/
template <typename... T>
void println(T&&... items)
{
    print(std::forward<T>(items)..., '\n');
}
```

## 实现原理

### 1. 线程安全的输出机制
```cpp
const std::scoped_lock stream_lock(stream_mutex);
```
- 使用 `scoped_lock` 确保在输出期间独占访问输出流
- 防止多个线程同时写入造成输出内容混乱
- 自动管理锁的生命周期，异常安全

### 2. 多流输出支持
```cpp
for (std::ostream* const stream : out_streams)
    (*stream << ... << items);
```
- 支持同时向多个输出流写入（如 `cout`、文件流等）
- 使用范围for循环遍历所有注册的输出流
- 确保所有流都能接收到相同的输出内容

### 3. C++17 折叠表达式
```cpp
(*stream << ... << items)
```
- 使用折叠表达式展开可变参数模板
- 等价于 `*stream << item1 << item2 << ... << itemN`
- 编译时展开，性能优异

### 4. 完美转发机制
```cpp
template <typename... T>
void println(T&&... items)
{
    print(std::forward<T>(items)..., '\n');
}
```
- `println` 使用万能引用 `T&&` 接收参数
- 通过 `std::forward` 完美转发参数到 `print` 函数
- 保持参数的值类别（左值/右值）

## 关键技术特性

### 线程安全保证
- **互斥锁保护**：所有输出操作都在锁保护下进行
- **原子输出**：每次调用 `print/println` 都是原子操作
- **避免交错**：防止不同线程的输出内容混合

### 性能优化
- **RAII锁管理**：使用 `scoped_lock` 自动管理锁生命周期
- **编译时优化**：模板和折叠表达式在编译时展开
- **最小锁持有时间**：只在实际输出时持有锁

### 灵活性设计
- **可变参数**：支持任意数量和类型的参数
- **多流支持**：可以同时输出到多个目标
- **类型安全**：编译时类型检查

## 应用场景

### 多线程调试
- 线程池工作线程的状态输出
- 并发任务的执行进度跟踪
- 线程间通信的调试信息

### 日志系统
- 多线程应用的日志记录
- 同时输出到控制台和文件
- 保证日志条目的完整性

### 性能监控
- 实时输出性能指标
- 多线程环境下的统计信息
- 避免输出内容的混乱

## 注意事项

### 使用建议
- 所有线程都应使用同一个 `synced_stream` 对象
- 避免在持有其他锁时调用输出函数，防止死锁
- 大量输出可能影响程序性能，生产环境需要控制输出频率

### 潜在问题
- 频繁的锁竞争可能成为性能瓶颈
- 输出流的缓冲机制可能影响实时性
- 异常情况下可能导致输出不完整

## 与标准库的对比

| 特性 | synced_stream | std::cout |
|------|---------------|-----------|
| 线程安全 | ✅ 完全安全 | ❌ 不安全 |
| 性能开销 | 🔸 有锁开销 | ✅ 无锁开销 |
| 多流支持 | ✅ 支持 | ❌ 单流 |
| 使用复杂度 | ✅ 简单 | 🔸 需要手动加锁 |
# 📝 AddressSanitizer（ASan）新手笔记

## 1. 编译方法

```bash
clang++ -fsanitize=address -g -O0 -fno-omit-frame-pointer main.cpp -o app
```

* `-fsanitize=address` → 开启 ASan
* `-g` → 带调试符号，报错能显示行号
* `-O0` → 关闭优化，方便调试
* `-fno-omit-frame-pointer` → 堆栈回溯更完整

> ⚠️ 要检测整个工程，所有文件都需要用这个编译。

---

## 2. 运行

直接运行：

```bash
./app
```

出错时 ASan 会打印：

* 错误类型（比如 stack-buffer-overflow, use-after-free）
* 访问的内存地址
* 堆栈调用信息（哪个文件、哪一行）

---

## 3. 堆栈信息显示

* 确保编译加了 `-g -fno-omit-frame-pointer`
* 安装 **llvm-symbolizer** 并放到 PATH：

  ```bash
  sudo apt install llvm
  export ASAN_SYMBOLIZER_PATH=$(which llvm-symbolizer)
  ```
* 常用选项：

  ```bash
  ASAN_OPTIONS=malloc_context_size=50:fast_unwind_on_malloc=0 ./app
  ```

  * `malloc_context_size` → 控制显示多少层调用栈
  * `fast_unwind_on_malloc=0` → 更准确的堆栈展开

---

## 4. 常用参数（ASAN\_OPTIONS）

```bash
ASAN_OPTIONS=参数1=值1:参数2=值2 ./app
```

| 参数                              | 默认值 | 作用                      |
| ------------------------------- | --- | ----------------------- |
| `detect_stack_use_after_return` | 0   | 检查“函数返回后继续用栈变量”         |
| `strict_string_checks`          | 0   | 严格检查字符串函数越界             |
| `halt_on_error`                 | 1   | 出错时立刻终止程序（设 0 → 不中止）    |
| `log_path`                      | 空   | 输出日志到文件                 |
| `malloc_context_size`           | 30  | 控制栈追踪深度                 |
| `quarantine_size_mb`            | 256 | 控制释放对象的隔离区大小，越大更易发现 UAF |

---

## 5. 最小例子

```cpp
#include <iostream>
int main() {
    int a[3] = {1,2,3};
    a[3] = 4;   // 越界写
    std::cout << "done\n";
    return 0;
}
```

编译 & 运行：

```bash
clang++ -fsanitize=address -g -O0 -fno-omit-frame-pointer test.cpp -o test
./test
```

输出示例：

```
==1234==ERROR: AddressSanitizer: stack-buffer-overflow on address ...
WRITE of size 4 at ...
    #0 0x55a1b0 in main /home/user/test.cpp:5
```

---

## 6. 总结口诀

* **编译时**：`-fsanitize=address -g -O0 -fno-omit-frame-pointer`
* **运行时**：`./app`，发现 bug 会自动报错
* **常用参数**：

  * 查栈问题 → `detect_stack_use_after_return=1`
  * 想不中断 → `halt_on_error=0`
  * 要日志 → `log_path=asan.log`
* **堆栈丢失行号？** → 安装 `llvm-symbolizer`


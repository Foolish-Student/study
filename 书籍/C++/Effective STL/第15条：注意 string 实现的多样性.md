# 📘 Effective STL 笔记

## 第 15 条：注意 `string` 实现的多样性

### 📌 背景

* `std::string` 是标准库的一部分，但 **标准只规定接口**，没有规定底层实现方式。
* 因此，不同编译器/标准库可能采用不同的实现策略。

---

### 📌 常见实现方式

| 实现方式                                | 特点                           | 优点              | 缺点                     |
| ----------------------------------- | ---------------------------- | --------------- | ---------------------- |
| **COW (Copy-On-Write)**             | 多个 `string` 对象共享同一块存储，修改时才复制 | 拷贝代价低，节省内存      | 多线程不安全，需要同步；C++11 后被废弃 |
| **SSO (Short String Optimization)** | 短字符串直接存在对象内部（常见 ≤ 15 个字节）    | 避免小字符串频繁堆分配，效率高 | 长度限制不同实现不一致            |
| **普通动态分配**                          | 每个字符串对象独立管理堆内存               | 实现简单，线程安全       | 小字符串频繁分配，性能差           |

---

### 📌 对使用者的影响

1. **性能差异**

   * 同一段代码，在不同实现下，拷贝/拼接的效率可能不同。
   * 例如：COW 在单线程下拷贝开销小；SSO 对短字符串特别高效。

2. **线程安全**

   * COW 实现依赖引用计数，多线程下可能需要原子操作，带来额外开销甚至错误。
   * 现代实现（SSO/普通分配）避免了这一问题。

3. **移植性**

   * 不要依赖具体实现细节（如 SSO 的存储长度、是否使用 COW）。
   * 应当只依赖标准接口，写出可移植代码。

---

### 📌 总结

* `std::string` 的底层实现方式**存在多样性**（COW、SSO、普通堆分配）。
* 这种差异会影响 **性能、内存使用、线程安全性**。
* **最佳实践**：只依赖标准接口，不依赖实现细节。写代码时考虑移植性，在性能敏感场合要做平台相关的测试。


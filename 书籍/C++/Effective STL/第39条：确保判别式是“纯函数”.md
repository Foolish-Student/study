# **第39条：确保判别式是“纯函数”**

## **1. 判别式的定义**

* **判别式（Predicate）** 是返回布尔值的函数或函数对象，用于判断元素是否满足某个条件。
* 常用于 STL 算法中，如：

  * `remove_if`
  * `find_if`
  * `count_if`
  * `sort`（自定义比较函数）

---

## **2. 纯函数的概念**

* **纯函数（Pure Function）** 特点：

  1. 相同输入总返回相同输出
  2. 不产生副作用（不修改全局变量、静态变量或容器内容）
* 纯函数保证算法在不同容器、不同上下文或重复调用时结果一致。

**示例：**

```cpp
bool isEven(int x) { return x % 2 == 0; }  // 纯函数

int counter = 0;
bool isEven(int x) { 
    counter++;       // 非纯函数，有副作用
    return x % 2 == 0; 
}
```

---

## **3. 为什么 STL 算法要求判别式是纯函数**

1. **算法可能多次调用判别式**

   * 为了排序、筛选或优化，STL 算法内部可能重复调用判别式
   * 如果判别式有副作用，可能导致结果不一致
2. **避免不可预测行为**

   * 判别式依赖外部状态或全局变量会影响结果
   * STL 在内部可能复制或移动函数对象，如果副作用依赖于状态，结果可能错误
3. **保证安全性与可重用性**

   * 纯函数能在任意容器和上下文中安全使用

---

## **4. 常见错误示例**

```cpp
int threshold = 5;
bool greaterThanThreshold(int x) { return x > threshold; }  // 外部状态依赖
```

* 依赖外部变量 `threshold`，如果被修改或多线程调用，结果可能不一致

**正确做法：**

```cpp
struct GreaterThan {
    int threshold;
    GreaterThan(int t) : threshold(t) {}
    bool operator()(int x) const { return x > threshold; }  // 按值捕获
};
```

* 判别式结果仅依赖输入参数和捕获值，保证纯函数特性

---

## **5. Lambda 实现纯函数**

```cpp
vector<int> v = {1, 2, 3, 4, 5};
int threshold = 3;
v.erase(remove_if(v.begin(), v.end(),
                  [threshold](int x){ return x > threshold; }),
        v.end());
```

* Lambda 按值捕获 `threshold`，判别式结果只依赖显式输入，符合纯函数原则

---

## **6. 总结原则**

* **输入依赖明确**：判别式的返回值只依赖函数参数和按值捕获的变量
* **无副作用**：禁止修改全局状态、静态变量或容器内容
* **可重复调用安全**：保证算法内部多次调用结果一致
* **线程安全**：纯函数保证并行或多线程场景下的安全性

> **核心思想**：判别式应仅依赖显式输入，避免外部状态，使 STL 算法的行为可预测、稳定和安全。
